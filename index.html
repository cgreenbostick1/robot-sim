<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Human-Robot EEG Simulation</title>
  <style>
    body { margin:0; display:flex; height:100vh; font-family:Arial,Helvetica,sans-serif; }

    /* LEFT: big chart pane */
    #chartPane {
      flex: 1;
      display:flex;
      flex-direction:column;
      min-width:0;
      padding:10px;
      background:#174f96; /* blue side */
      color:#fff;
      gap:8px;
    }
    #chartPane h4 { margin:0 0 4px 0; }
    #chartWrap {
      flex:1;
      background:#fff;   /* chart sits on white for contrast */
      border-radius:6px;
      padding:10px;
      overflow:hidden;
    }
    #legend { font-size:13px; color:#dfe8ff; }

    /* RIGHT: smaller sidebar for 3D + controls */
    #right {
      width:420px;
      display:flex;
      flex-direction:column;
      background:#fff;
      border-left:1px solid #ddd;
    }
    #canvasContainer { flex: 1; background:#eef; }
    #controls { padding:10px; background:#f4f4f4; border-top:1px solid #ddd; }

    canvas { display:block; }
  </style>
</head>
<body>

  <!-- LEFT (big): Chart -->
  <div id="chartPane">
    <h4>Simulated EEG / Affect Signals</h4>
    <div id="chartWrap">
      <canvas id="chart"></canvas>
    </div>
    <p id="legend">Blue = Focus &nbsp;|&nbsp; Orange = Stress &nbsp;|&nbsp; Green = Engagement</p>
  </div>

  <!-- RIGHT (small): 3D + controls -->
  <div id="right">
    <div id="canvasContainer"></div>
    <div id="controls">
      <label>Task Difficulty:
        <input id="difficulty" type="range" min="0" max="3" step="0.1" value="1">
      </label>
      <button id="toggle">Pause Simulation</button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <script>
  /* --------------------- THREE.JS (RIGHT SIDEBAR) --------------------- */
  const container = document.getElementById('canvasContainer');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  container.appendChild(renderer.domElement);

  // Camera & background
  camera.position.set(4, 3, 6);
  camera.lookAt(0, 1, 0);
  renderer.setClearColor(0xf0f0f0);

  function resize3D(){
    const w = container.clientWidth, h = container.clientHeight || 1;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  resize3D();
  if (window.ResizeObserver) new ResizeObserver(resize3D).observe(container);
  window.addEventListener('resize', resize3D);

  // Lights
  scene.add(new THREE.AmbientLight(0x888888));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5,10,5);
  scene.add(light);

  // Robot
  const base = new THREE.Mesh(
    new THREE.BoxGeometry(1, 0.2, 1),
    new THREE.MeshStandardMaterial({ color: 0x2b6f77 })
  );
  base.position.y = 0.1;
  scene.add(base);

  const arm = new THREE.Mesh(
    new THREE.BoxGeometry(0.3, 1.5, 0.3),
    new THREE.MeshStandardMaterial({ color: 0x1565c0 })
  );
  arm.position.y = 0.75;
  base.add(arm);

  const gripper = new THREE.Mesh(
    new THREE.BoxGeometry(0.8, 0.1, 0.2),
    new THREE.MeshStandardMaterial({ color: 0x222222 })
  );
  gripper.position.y = 0.9;
  arm.add(gripper);

  if (THREE.OrbitControls) {
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    (function tick(){ controls.update(); requestAnimationFrame(tick); })();
  }

  /* --------------------- CHART (LEFT BIG PANE) --------------------- */
  const chartCanvas = document.getElementById('chart');
  const MAX_POINTS = 60;
  const chart = new Chart(chartCanvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: Array(MAX_POINTS).fill(""),
      datasets: [
        { label: 'Focus',      data: Array(MAX_POINTS).fill(0.5), borderColor: 'blue',   fill: false, tension: 0.2 },
        { label: 'Stress',     data: Array(MAX_POINTS).fill(0.5), borderColor: 'orange', fill: false, tension: 0.2 },
        { label: 'Engagement', data: Array(MAX_POINTS).fill(0.5), borderColor: 'green',  fill: false, tension: 0.2 }
      ]
    },
    options: {
      responsive: false,             // we'll size it ourselves to fill the pane
      maintainAspectRatio: false,
      animation: false,
      scales: { y: { min: 0, max: 1 } },
      plugins: { legend: { display: true } }
    }
  });

  function sizeChartCanvas(){
    const wrap = document.getElementById('chartWrap');
    // fill the white card
    chartCanvas.width  = wrap.clientWidth - 20;
    chartCanvas.height = wrap.clientHeight - 20;
    chart.resize();
  }
  sizeChartCanvas();
  if (window.ResizeObserver) new ResizeObserver(sizeChartCanvas).observe(document.getElementById('chartWrap'));
  window.addEventListener('resize', sizeChartCanvas);

  /* --------------------- SIMULATION --------------------- */
  let running = true;
  document.getElementById('toggle').onclick = () => {
    running = !running;
    document.getElementById('toggle').textContent = running ? "Pause Simulation" : "Resume Simulation";
  };

  function simulateEEG(t, difficulty){
    const focus   = 0.5 + 0.3*Math.sin(t*0.002) - 0.05*difficulty;
    const stress  = 0.4 + 0.4*Math.cos(t*0.0015 + difficulty);
    const engage  = 0.6 + 0.2*Math.sin(t*0.001*difficulty + 2);
    const clamp = v => Math.max(0, Math.min(1, v));
    return [clamp(focus), clamp(stress), clamp(engage)];
  }

  function animate(time){
    requestAnimationFrame(animate);
    if (running) {
      const diff = parseFloat(document.getElementById('difficulty').value);
      base.rotation.y += 0.005 * diff;
      arm.rotation.z   = 0.3 * Math.sin(time * 0.001 * diff);
      gripper.rotation.x = 0.2 * Math.sin(time * 0.002 * diff);

      const [f,s,e] = simulateEEG(time, diff);
      chart.data.datasets[0].data.push(f);
      chart.data.datasets[1].data.push(s);
      chart.data.datasets[2].data.push(e);
      chart.data.datasets.forEach(ds => { if (ds.data.length > MAX_POINTS) ds.data.shift(); });
      chart.update("none");
    }
    renderer.render(scene, camera);
  }
  animate(0);
  </script>
</body>
</html>
